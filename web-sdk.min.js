!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).YuDataWebSDK={})}(this,function(e){"use strict";const t={show_log:!1,is_track_single_page:!1,use_client_time:!1,send_type:"beacon",heatmap:{},web_url:void 0,cross_subdomain:!1,source_channel:[],source_type:{},max_string_length:1024,queue_timeout:300,datasend_timeout:8e3,preset_properties:{},sls:void 0,debug:!1,autoTrack:!0},i=()=>{let e=(new Date).getTime(),t="undefined"!=typeof performance&&performance.now&&1e3*performance.now()||0;return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(i){let n=16*Math.random();return e>0?(n=(e+n)%16|0,e=Math.floor(e/16)):(n=(t+n)%16|0,t=Math.floor(t/16)),("x"===i?n:3&n|8).toString(16)})};class n{constructor(e=!1){this.enabled=!1,this.enabled=e}enable(){this.enabled=!0}disable(){this.enabled=!1}info(...e){this.enabled&&console.log("[WebSDK]",...e)}error(...e){this.enabled&&console.error("[WebSDK]",...e)}warn(...e){this.enabled&&console.warn("[WebSDK]",...e)}}const o={get:e=>localStorage.getItem(e),set(e,t){localStorage.setItem(e,t)},remove(e){localStorage.removeItem(e)}},s={name:"DeviceInfo",install:e=>{const t=navigator.userAgent,i=window.screen.width,n=window.screen.height,o=navigator.language;let s="Unknown";-1!==t.indexOf("Win")?s="Windows":-1!==t.indexOf("Mac")?s="MacOS":-1!==t.indexOf("Linux")?s="Linux":-1!==t.indexOf("Android")?s="Android":-1!==t.indexOf("like Mac")&&(s="iOS");let r="Unknown";-1!==t.indexOf("Chrome")?r="Chrome":-1!==t.indexOf("Firefox")?r="Firefox":-1!==t.indexOf("Safari")&&-1===t.indexOf("Chrome")?r="Safari":-1!==t.indexOf("Edge")&&(r="Edge");const a={$os:s,$browser:r,$screen_width:i,$screen_height:n,$language:o,$user_agent:t};e.registerCommonProperties(a)}},r={name:"AutoTrack",install:e=>{const t=e.config.heatmap||{},i=()=>{if(e.config.disablePageview)return;const t={$url:window.location.href,$title:document.title,$path:window.location.pathname,$referrer:document.referrer};e.track("$pageview",t)};if("complete"===document.readyState?i():window.addEventListener("load",i),e.config.is_track_single_page){const e=history.pushState;history.pushState=function(...t){e.apply(this,t),setTimeout(i,0)};const t=history.replaceState;history.replaceState=function(...e){t.apply(this,e),setTimeout(i,0)},window.addEventListener("popstate",i),window.addEventListener("hashchange",i)}!e.config.disableClick&&"not_collect"!==t.clickmap&&document.addEventListener("click",t=>{const i=e.config.heatmap||{},n=t.target;if(i.collect_url&&!i.collect_url())return;if(i.collect_element&&!i.collect_element(n))return;let o=null;if(a(n,i))o=n;else{let e=n.parentElement;for(;e&&e!==document.body;){if(a(e,i)){o=e;break}e=e.parentElement}}if(!o)return;const s={$element_id:o.id,$element_class_name:o.className,$element_content:c(o,i),$element_type:o.tagName,$element_selector:l(o,i),$page_x:t.pageX,$page_y:t.pageY,$url:window.location.href,$title:document.title};if(i.custom_property){const e=i.custom_property(o);e&&Object.assign(s,e)}e.track("$WebClick",s)},!0);if(!e.config.disableStay&&"not_collect"!==t.scroll_notice_map){let i=Date.now(),n=null,o=0;const s="number"==typeof t.scroll_delay_time?t.scroll_delay_time:4e3,r="number"==typeof t.scroll_event_duration?t.scroll_event_duration:18e3,a=()=>{const t=Date.now(),n=t-i;if(n>=s){o+=n;const s=Math.min(o,1e3*r);e.track("$WebStay",{$duration:s,$url:window.location.href,$title:document.title}),i=t}},c=()=>{n&&clearTimeout(n),n=setTimeout(a,s)};window.addEventListener("scroll",()=>{c()},{passive:!0});const l=()=>{a()};window.addEventListener("beforeunload",l),document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState?l():(i=Date.now(),c())}),c()}}};function a(e,t){const i=e.tagName.toLowerCase();if(e.hasAttribute("data-sensors-click"))return!0;if(Array.isArray(t.track_attr))for(const i of t.track_attr)if(e.hasAttribute(i))return!0;if(["a","button","input","textarea"].includes(i))return!0;if(t.collect_tags&&t.collect_tags[i]){const n=t.collect_tags[i];if(!0===n)return!0;if("object"==typeof n&&"number"==typeof n.max_level){let t=0,i=e;for(;i&&i!==document.body&&t<=n.max_level;)i=i.parentElement,t++;return t<=n.max_level+1}}return!1}function c(e,t){return"INPUT"===e.tagName||"TEXTAREA"===e.tagName?t.collect_input&&t.collect_input(e)&&e.value||"":e.innerText||""}function l(e,t){return"not_use_id"!==t.element_selector&&e.id?"#"+e.id:e.className&&"string"==typeof e.className?"."+e.className.split(" ").join("."):e.tagName.toLowerCase()}class d{constructor(){this.loginId=null,this.commonProperties={},this.dynamicProperties={},this.plugins=[],this.identities={},this.queue=[],this.processing=!1,this.config=t,this.logger=new n(this.config.debug),this.anonymousId=o.get("web_sdk_distinct_id")||i(),this.identities=JSON.parse(o.get("web_sdk_identities")||"{}"),o.set("web_sdk_distinct_id",this.anonymousId)}init(e){this.config={...this.config,...e},void 0!==this.config.show_log&&(this.config.debug=this.config.show_log),this.config.debug&&this.logger.enable(),this.logger.info("SDK Initialized",this.config);const t=this.parseSourceAttribution();Object.keys(t).length&&this.registerCommonProperties(t),this.use(s),(this.config.autoTrack||this.config.heatmap&&"default"===this.config.heatmap.clickmap)&&this.use(r)}quick(e,...t){if("autoTrack"===e)this.logger.info("quick autoTrack called");else if("isReady"===e)"function"==typeof t[0]&&t[0]();else if("trackHeatMap"===e){const e=t[0],i=t[1]||{};e&&this.trackHeatMap(e,i)}else if("trackAllHeatMap"===e){const e=t[0],i=t[1]||{};e&&this.trackAllHeatMap(e,i)}}use(e){this.logger.info(`Installing plugin: ${e.name}`),e.install(this),this.plugins.push(e)}registerCommonProperties(e){const t={};for(const i in e)"function"==typeof e[i]?this.dynamicProperties[i]=e[i]:t[i]=e[i];this.commonProperties={...this.commonProperties,...t}}registerPage(e){this.registerCommonProperties(e)}clearCommonProperties(){this.commonProperties={},this.dynamicProperties={}}login(e){this.loginId=e,this.storeSet("web_sdk_login_id",e),this.track("$SignUp",{$original_id:this.anonymousId})}identify(e){this.anonymousId=e,this.storeSet("web_sdk_distinct_id",this.anonymousId)}logout(){this.loginId=null,this.storeRemove("web_sdk_login_id"),this.identities={},this.storeRemove("web_sdk_identities")}bind(e,t){this.identities[e]=t,this.storeSet("web_sdk_identities",JSON.stringify(this.identities)),this.track("$BindID",{[`${e}`]:t},"track_id_bind")}unbind(e,t){this.identities[e]===t&&(delete this.identities[e],this.storeSet("web_sdk_identities",JSON.stringify(this.identities))),this.track("$UnbindID",{[`${e}`]:t},"track_id_unbind")}resetAnonymousIdentity(e){const t=e||i();this.anonymousId=t,this.storeSet("web_sdk_distinct_id",this.anonymousId)}setProfile(e){this.track("$profile_set",e,"profile_set")}setProfileOnce(e){this.track("$profile_set_once",e,"profile_set_once")}incrementProfile(e){let t={};"string"==typeof e?t[e]=1:t=e,this.track("$profile_increment",t,"profile_increment")}appendProfile(e){this.track("$profile_append",e,"profile_append")}deleteProfile(){this.track("$profile_delete",{},"profile_delete")}unsetProfile(e){const t={};Array.isArray(e)?e.forEach(e=>t[e]=!0):t[e]=!0,this.track("$profile_unset",t,"profile_unset")}trackHeatMap(e,t={}){const i=this.buildClickProperties(e);Object.assign(i,t),this.track("$WebClick",i)}trackAllHeatMap(e,t={}){const i=this.buildClickProperties(e);Object.assign(i,t),this.track("$WebClick",i)}buildClickProperties(e){return{$element_id:e.id,$element_class_name:e.className,$element_content:this.getElementContent(e),$element_type:e.tagName,$element_selector:this.getSelector(e),$url:window.location.href,$title:document.title}}getElementContent(e){return"INPUT"===e.tagName||"TEXTAREA"===e.tagName?e.value||"":e.innerText||""}getSelector(e){return this.config.heatmap&&"not_use_id"!==this.config.heatmap.element_selector&&e.id?"#"+e.id:e.className&&"string"==typeof e.className?"."+e.className.split(" ").join("."):e.tagName.toLowerCase()}track(e,t={},i="track"){const n={};for(const e in this.dynamicProperties)try{const t=this.dynamicProperties[e]();void 0!==t&&"function"!=typeof t&&(n[e]=t)}catch(e){}const o={event:e,type:i,properties:this.applyStringLimit({...this.commonProperties,...n,...t,$time:Date.now()}),time:Date.now(),distinct_id:this.loginId||this.anonymousId,anonymous_id:this.anonymousId,login_id:this.loginId||void 0,identities:{$identity_anonymous_id:this.anonymousId,$identity_cookie_id:this.anonymousId,...this.loginId?{$identity_login_id:this.loginId}:{},...this.identities}};this.logger.info(`Track Event: ${e}`,o);const s={event_type:e,event_data:JSON.stringify(o)};this.send(s)}getPresetProperties(){return{$url:window.location.href,$title:document.title,$referrer:document.referrer,$screen_width:window.screen.width,$screen_height:window.screen.height,$sdk_version:"1.0.0"}}send(e){if("sls"!==(this.config.send_type||"beacon")){if(!this.config.server_url)return void this.logger.warn("Server URL not configured. Dropping event.")}else if(!this.isSLSConfigValid())return void this.logger.warn("SLS config not valid. Dropping event.");(()=>{if(this.queue.push(e),!this.processing){this.processing=!0;const e=this.config.queue_timeout||0;setTimeout(()=>this.flush(),e)}})()}flush(){const e=this.queue.shift();if(!e)return void(this.processing=!1);const t=this.config.send_type||"beacon",i=JSON.stringify(e),n=()=>{if(this.queue.length>0){const e=this.config.queue_timeout||0;setTimeout(()=>this.flush(),e)}else this.processing=!1};if("sls"===t)return void this.sendSLS(e,n);const o=this.config.server_url;if("beacon"===t){const e=new Blob([i],{type:"application/json"});return void(navigator.sendBeacon(o,e)?n():this.sendAjax(o,i).finally(n))}if("ajax"!==t)if("image"!==t)this.sendAjax(o,i).finally(n);else try{const e=new Image;e.onload=()=>n(),e.onerror=()=>n();const t=encodeURIComponent(i);e.src=`${o}?data=${t}`}catch{n()}else this.sendAjax(o,i).finally(n)}isSLSConfigValid(){const e=this.config.sls;return!!e&&(!!e.endpoint||!!(e.project&&e.logstore&&e.region))}buildSLSUrl(e){const t=this.config.sls,i=t.endpoint?t.endpoint:`https://${t.project}.${t.region}.log.aliyuncs.com`,n=`/logstores/${t.logstore}/track`,o={APIVersion:"0.6.0",__topic__:e.event},s={...e.properties,distinct_id:e.distinct_id,anonymous_id:e.anonymous_id};for(const e in s){const t=s[e];null!=t&&(o[e]="object"==typeof t?JSON.stringify(t):t)}return`${i}${n}?${this.toQuery(o)}`}toQuery(e){const t=[];for(const i in e){const n=e[i];t.push(encodeURIComponent(i)+"="+encodeURIComponent(String(n)))}return t.join("&")}sendSLS(e,t){const i=this.config.sls;let n=e;if(e.event_data&&"string"==typeof e.event_data)try{n=JSON.parse(e.event_data)}catch{}if("get"===(i.method||"get")){try{const e=this.buildSLSUrl(n),i=new Image;i.onload=()=>t(),i.onerror=()=>t(),i.src=e}catch{t()}return}const o=(i.endpoint?i.endpoint:`https://${i.project}.${i.region}.log.aliyuncs.com`)+`/logstores/${i.logstore}/track?APIVersion=0.6.0`,s=JSON.stringify({__topic__:n.event,...n.properties,distinct_id:n.distinct_id,anonymous_id:n.anonymous_id}),r="undefined"!=typeof AbortController?new AbortController:void 0,a=this.config.datasend_timeout||8e3,c=r?setTimeout(()=>r.abort(),a):null;fetch(o,{method:"POST",body:s,headers:{"Content-Type":"application/json"},keepalive:!0,signal:r?r.signal:void 0}).catch(()=>{}).finally(()=>{c&&clearTimeout(c),t()})}sendAjax(e,t){const i="undefined"!=typeof AbortController?new AbortController:void 0,n=this.config.datasend_timeout||8e3,o=i?setTimeout(()=>i.abort(),n):null;return fetch(e,{method:"POST",body:t,headers:{"Content-Type":"application/json"},keepalive:!0,signal:i?i.signal:void 0}).catch(e=>{this.logger.error("Failed to send event",e)}).finally(()=>{o&&clearTimeout(o)})}storeSet(e,t){if(this.config.cross_subdomain){const i=this.getRootDomain();if(i)return void(document.cookie=`${e}=${encodeURIComponent(t)};path=/;domain=.${i}`)}o.set(e,t)}storeRemove(e){if(this.config.cross_subdomain){const t=this.getRootDomain();if(t)return void(document.cookie=`${e}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=.${t}`)}o.remove(e)}getRootDomain(){const e=window.location.hostname;if(/^\d+\.\d+\.\d+\.\d+$/.test(e)||"localhost"===e)return null;const t=e.split(".");return t.length<=2?e:t.slice(t.length-2).join(".")}parseSourceAttribution(){const e=new URL(window.location.href).searchParams,t={};return["utm_source","utm_medium","utm_campaign","utm_term","utm_content"].forEach(i=>{const n=e.get(i);n&&(t[i]=n)}),Array.isArray(this.config.source_channel)&&this.config.source_channel.forEach(i=>{const n=e.get(i);n&&(t[i]=n)}),t}applyStringLimit(e){const t=this.config.max_string_length||1024,i={};for(const n in e){const o=e[n];"string"==typeof o&&o.length>t?i[n]=o.slice(0,t):i[n]=o}return i}}const h=new d;e.WebSDK=d,e.sdk=h});
//# sourceMappingURL=web-sdk.min.js.map
